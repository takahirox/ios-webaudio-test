<!DOCTYPE html>
<html lang="en">
<head>
  <title>iOS WebAudio simple test</title>
  <meta charset="utf-8">
</head>
<body>
  <audio loop id="music" preload="auto" style="display: none" crossOrigin="anonymous">
    <source src="audios/376737_Skullbeatz___Bad_Cat_Maste.mp3" type="audio/mp3">
  </audio>

  <div>
    <button id="playWithWebAudioButton">Play with WebAudio</button>
    <button id="playWithoutWebAudioButton">Play without WebAudio</button>
  </div>

  <br />

  <div>
    WebAudio AudioContext constructor optional parameters<br />
    <br />
    latencyHint
    <select id="latencyHintSelect">
      <option value="None" selected>None</option>
      <option value="balanced">balanced</option>
      <option value="interactive">interactive</option>
      <option value="playback">playback</option>
    </select>
    <br />
    sampleRate <input id="sampleRateText" type="text"></input>
    <br />
    <div id="errorMessage" style="color: red"></div>
  </div>

  <br />

  <div><a href="https://github.com/takahirox/ios-webaudio-test" target="_blank">Source code</a></div>
  <div id="info">
    music by <a href="http://www.newgrounds.com/audio/listen/376737" target="_blank" rel="noopener noreferrer">skullbeatz</a>
  </div>

  <br />

  <div id="useragent"></div>

  <script type="module">
    const disableElements = () => {
      document.getElementById('playWithWebAudioButton').disabled = true;
      document.getElementById('playWithoutWebAudioButton').disabled = true;
      document.getElementById('latencyHintSelect').disabled = true;
      document.getElementById('sampleRateText').disabled = true;
    };

    const createAudioContextParameters = () => {
      const options = {};

      const latencyHintSelect = document.getElementById('latencyHintSelect');
      const sampleRateText = document.getElementById('sampleRateText');

      const latencyHintOption = latencyHintSelect.options[latencyHintSelect.selectedIndex];
      const sampleRateValue = sampleRateText.value;

      if (latencyHintOption.value !== 'None') { options.latencyHint = latencyHintOption.value; }
      if (sampleRateValue !== '') { options.sampleRate = parseInt(sampleRateValue); }

      console.log('AudioContext constructor parameters', options);

      return options;
    };

    const playWithWebAudio = () => {
      disableElements();

      try {
        const audioElement = document.getElementById('music');
        const context = new (window.AudioContext || window.webkitAudioContext)(createAudioContextParameters());
        const source = context.createMediaElementSource(audioElement);
        source.connect(context.destination);

        audioElement.play();
      } catch (e) {
        document.getElementById('errorMessage').innerText = e.message;
        console.error(e);
      }
    };

    const playWithoutWebAudio = () => {
      disableElements();

      try {
        const audioElement = document.getElementById('music');
        audioElement.play();
      } catch (e) {
        document.getElementById('errorMessage').innerText = e.message;
        console.error(e);
      }
    };

    document.getElementById('playWithWebAudioButton').addEventListener('click', playWithWebAudio);
    document.getElementById('playWithoutWebAudioButton').addEventListener('click', playWithoutWebAudio);
    document.getElementById('useragent').innerText = navigator.userAgent;
  </script>
</body>
</html>
